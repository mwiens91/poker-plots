const drawBoxPlot=(t,e,a,l)=>{const r=20,n=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}),o=t.players.filter((t=>t.data.length>2)).map((t=>{const e=t.data.map((t=>t.cumSum)),a=d3.quantile(e,.25),l=d3.quantile(e,.5),r=d3.quantile(e,.75),n=r-a,o=d3.max([d3.min(e),a-1.5*n]),s=d3.min([d3.max(e),r+1.5*n]);return{...t,quartiles:[a,l,r],range:[o,s],outliers:e.filter((t=>t<o||t>s))}}));let s=Math.min(a,document.getElementById(e).clientWidth),c=.65*s;const d=d3.scaleBand().domain(o.map((t=>t.name))).paddingInner(1).paddingOuter(.5).range([0,s-l.left-l.right]),i=d3.scaleLinear().domain(d3.extent(o.map((t=>[...t.outliers,...t.range])).flat()).map((t=>1.05*t))).range([c-l.top-l.bottom,0]),m=d3.select("#"+e).append("svg"),p=d3.select("#"+e).append("div").style("opacity",0).style("position","absolute").attr("class","tooltip"),u=(t,e)=>p.style("left",t.pageX+30+"px").style("top",t.pageY-20+"px"),g=(t,e)=>p.style("opacity",0),y=(t,e)=>p.style("opacity",.8).html(`max: ${n.format(e.range[1])}<br>75% quantile: ${n.format(e.quartiles[2])}<br>50% quantile: ${n.format(e.quartiles[1])}<br>25% quantile: ${n.format(e.quartiles[0])}<br>min: ${n.format(e.range[0])}`),h=(t,e)=>p.style("opacity",.8).html("outlier: "+n.format(e)),f=()=>{const t=m.attr("viewBox","0 0 "+(s+l.left+l.right)+" "+(c+l.top+l.bottom)).append("g").attr("transform",`translate(${l.left+l.right}, ${l.top+l.bottom})`),e=d3.axisBottom(d),a=d3.axisLeft(i).tickFormat((t=>n.format(t))).ticks(10),p=d3.axisLeft(i).tickSize(l.left+l.right-s).tickFormat("").ticks(10).tickSizeOuter(0);t.append("g").attr("class","y axis-grid").call(p),t.append("g").attr("class","x axis").attr("transform",`translate(0, ${c-l.top-l.bottom})`).call(e),t.append("g").attr("class","y axis").call(a).append("text").attr("y",15).attr("transform","rotate(-90)").attr("fill","#000").text("cumulative sum (CAD)"),t.selectAll("vertlines").data(o).enter().append("path").attr("d",(t=>`\n      M${d(t.name)}, ${i(t.range[1])}\n      V${i(t.range[0])}\n      `)).attr("stroke","black").style("width",40).on("mouseover",y).on("mousemove",u).on("mouseout",g),t.selectAll("boxes").data(o).enter().append("path").attr("fill",(t=>t.colourHex)).attr("d",(t=>`\n        M${d(t.name)+r}, ${i(t.quartiles[2])}\n        H${d(t.name)-r}\n        V${i(t.quartiles[0])}\n        H${d(t.name)+r}\n        Z\n      `)).on("mouseover",y).on("mousemove",u).on("mouseout",g),t.selectAll("horizlines").data(o).enter().append("path").attr("stroke","black").attr("d",(t=>`\n        M${d(t.name)+r},${i(t.quartiles[1])}\n        H${d(t.name)-r}\n      `)).on("mouseover",y).on("mousemove",u).on("mouseout",g),t.selectAll("horizlines").data(o).enter().append("path").attr("stroke","black").attr("d",(t=>`\n        M${d(t.name)+r/3},${i(t.range[1])}\n        H${d(t.name)-r/3}\n      `)).on("mouseover",y).on("mousemove",u).on("mouseout",g),t.selectAll("horizlines").data(o).enter().append("path").attr("stroke","black").attr("d",(t=>`\n        M${d(t.name)+r/3},${i(t.range[0])}\n        H${d(t.name)-r/3}\n      `)).on("mouseover",y).on("mousemove",u).on("mouseout",g),t.selectAll("circle-group").data(o).enter().append("g").attr("fill",(t=>t.colourHex)).attr("fill-opacity",.5).attr("stroke","none").attr("transform",(t=>`translate(${d(t.name)}, 0)`)).selectAll("circle").data((t=>t.outliers)).enter().append("g").attr("class","circle").append("circle").attr("r",3).attr("cx",(()=>0*(Math.random()-.5))).attr("cy",(t=>i(t))).on("mouseover",h).on("mousemove",u).on("mouseout",g)};return f(),()=>{s=Math.min(a,document.getElementById(e).clientWidth),c=.65*s,d.range([0,s-l.left-l.right]),i.range([c-l.top-l.bottom,0]),m.selectAll("*").remove(),f()}},drawCalendar=(t,e,a)=>{const l=17,r=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}),n=d3.utcParse("%Y-%m-%d");let o=t.games.map((t=>({date:n(t.date),val:t.data.reduce(((t,e)=>t+e.buyin),0),id:t.id})));const s=d3.utcDays(new Date(Date.UTC(o[o.length-1].date.getFullYear(),0,1)),o[o.length-1].date);let c=d3.utcDays(o[0].date,new Date(Date.UTC(o[0].date.getFullYear()+1,0,1)));c.shift();let d=[...s,...c];o.reduce(((t,e)=>{let a=d3.utcDays(e.date,t.date);return a.shift(),d.push(...a),e}));for(const t of d)o.push({date:t,val:0,id:null});o.sort(((t,e)=>e.date-t.date));const i=d3.map(o,(t=>t.date)),m=d3.map(o,(t=>t.val)),p=d3.range(i.length),u=d3.groups(p,(t=>i[t].getUTCFullYear())),g=d3.utcFormat("%b"),y=d3.scaleSqrt().domain([0,d3.max(o.map((t=>t.val)))]).range(["#ebedf0","teal"]),h=d3.select("#"+e).append("svg").attr("id","calendar-svg"),f=d3.select("#"+e).append("div").style("opacity",0).style("position","absolute").attr("class","tooltip");h.attr("width",950+a.left+a.right).attr("height",153*u.length+a.top+a.bottom).attr("viewBox","0 0 "+(950+a.left+a.right)+" "+(153*u.length+a.top+a.bottom)).attr("font-family","sans-serif").attr("font-size",10);const x=h.selectAll("g").data(u).join("g").attr("transform",((t,e)=>`translate(40.5,${153*e+25.5})`));x.append("text").attr("x",-5).attr("y",-5).attr("font-weight","bold").attr("text-anchor","end").text((([t])=>t)),x.append("g").attr("text-anchor","end").selectAll("text").data(d3.range(7)).join("text").attr("x",-5).attr("y",(t=>(t+.5)*l)).attr("dy","0.31em").text((t=>"SMTWRFS"[t])),x.append("g").selectAll("rect").data((([,t])=>t)).join("rect").attr("width",16).attr("height",16).attr("x",(t=>d3.utcSunday.count(d3.utcYear(i[t]),i[t])*l+.5)).attr("y",(t=>i[t].getUTCDay()*l+.5)).attr("fill",(t=>y(m[t]))).on("mouseover",((t,e)=>f.style("opacity",.8).html(`<b>${i[e].toLocaleDateString("en-US",{timeZone:"UTC",weekday:"long",year:"numeric",month:"long",day:"numeric"})}</b><br>`+(null===o[e].id?"no game":`total buy-ins: ${r.format(o[e].val)}`)))).on("mousemove",((t,e)=>f.style("left",t.pageX+30+"px").style("top",t.pageY-20+"px"))).on("mouseout",((t,e)=>f.style("opacity",0))).on("click",((t,e)=>null===o[e].id?null:document.getElementById("game-"+o[e].id).scrollIntoView()));const b=x.append("g").selectAll("g").data((([,t])=>d3.utcMonths(i[t[t.length-1]],i[t[0]]))).join("g");b.filter(((t,e)=>e)).append("path").attr("fill","none").attr("stroke","#fff").attr("stroke-width",3).attr("d",(t=>{const e=Math.min(7,t.getUTCDay()),a=d3.utcSunday.count(d3.utcYear(t),t);return(7===e?`M${(a+1)*l},0`:`M${(a+1)*l},0V${e*l}H${a*l}`)+"V119"})),b.append("text").attr("x",(t=>d3.utcSunday.count(d3.utcYear(t),d3.utcSunday.ceil(t))*l+2)).attr("y",-5).text(g)},drawLinePlot=(t,e,a,l)=>{const r="0.1rem",n="0.15rem",o=.85,s="0.2em";let c=!0;const d=t=>c?t.date:t.id,i=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}),m=d3.utcParse("%Y-%m-%d"),p=t.players.map((t=>({...t,data:t.data.map((t=>({...t,date:m(t.date)})))}))),u=p.map((t=>t.data.map((t=>t.date)))).flat(),g=d3.min(u);let y=new Date(Number(g));y.setDate(g.getDate()-1);let h=Math.min(a,document.getElementById(e).clientWidth),f=.5*h;const x=d3.max(u),b=d3.max(t.games.map((t=>t.id))),v=Math.max(1,(x.getTime()-g.getTime())/12096e5),w=Math.max(1,(b-1)/10);let k=(c?d3.scaleUtc:d3.scaleLinear)().domain(c?[y,x]:[.9,b]).range([0,h-l.left-l.right]),$=k.copy();const A=d3.scaleLinear().domain(d3.extent(p.map((t=>t.data.map((t=>t.cumSum)))).flat()).map((t=>1.05*t))).range([f-l.top-l.bottom,0]),S=d3.select("#"+e).append("svg"),M=()=>{const t=S.attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+(h+l.left+l.right)+" "+(f+l.top+l.bottom)).append("g").attr("transform",`translate(${l.left+l.right}, ${l.top+l.bottom})`),e=d3.axisBottom(k),a=d3.axisLeft(A).tickFormat((t=>i.format(t))).ticks(10),m=d3.axisLeft(A).tickSize(l.left+l.right-h).tickFormat("").ticks(10).tickSizeOuter(0);t.append("g").attr("class","y axis-grid").call(m);const u=t.append("g").attr("class","x axis").attr("transform",`translate(0, ${f-l.top-l.bottom})`).call(e);t.append("g").attr("class","y axis").call(a).append("text").attr("y",15).attr("transform","rotate(-90)").attr("fill","#000").text("cumulative sum (CAD)"),t.append("defs").append("svg:clipPath").attr("id","clip").append("svg:rect").attr("width",h).attr("height",f).attr("x",0).attr("y",0);const g=t.append("g").attr("clip-path","url(#clip)"),M=d3.line().x((t=>k(d(t)))).y((t=>A(t.cumSum))),D=d3.select("#line-plot-avatar-div"),E=d3.select("#line-plot-player-div"),I=d3.select("#line-plot-game-div"),B=d3.select("#line-plot-avatar"),F=d3.select("#line-plot-player"),L=d3.select("#line-plot-amount"),U=d3.select("#line-plot-game-title"),z=d3.select("#line-plot-game-info");let P=g.append("g").attr("class","lines");P.selectAll(".line-group").data(p).enter().append("g").attr("class","line-group").append("path").attr("class","line").attr("d",(t=>M(t.data))).style("stroke",(t=>t.colourHex)).style("stroke-width",r).style("opacity",.6).on("mouseover",((t,e)=>{d3.selectAll(".line").style("opacity",.15),d3.selectAll(".circle").style("opacity",.6),d3.select(t.currentTarget).style("opacity",.85).style("stroke-width",n).style("cursor","pointer"),D.style("background","rgb("+e.colourRgb+")"),E.style("background","rgb("+e.colourRgb.map((t=>t+.4*(255-t)))+")"),B.attr("src",e.avatar),F.text(e.name),L.text(i.format(e.cumSum))})).on("mouseout",((t,e)=>{d3.selectAll(".line").style("opacity",.6),d3.selectAll(".circle").style("opacity",o),d3.select(t.currentTarget).style("stroke-width",r).style("cursor","none")})),P.selectAll("circle-group").data(p).enter().append("g").style("fill",(t=>t.colourHex)).selectAll("circle").data((t=>t.data)).enter().append("g").attr("class","circle").append("circle").attr("cx",(t=>k(d(t)))).attr("cy",(t=>A(t.cumSum))).attr("r",s).style("opacity",o).on("mouseover",((t,e)=>{d3.select(t.currentTarget).transition().attr("r","0.4em");const a=p.filter((t=>t.name===e.player))[0];D.style("background","rgb("+a.colourRgb+")"),E.style("background","rgb("+a.colourRgb.map((t=>t+.4*(255-t)))+")"),B.attr("src",a.avatar),F.text(a.name),L.text(i.format(a.cumSum)),I.style("background","rgb("+a.colourRgb.map((t=>t+.8*(255-t)))+")"),U.text(e.date.toLocaleDateString("en-US",{timeZone:"UTC",weekday:"long",year:"numeric",month:"long",day:"numeric"})),z.text("buy-in: "+i.format(e.buyin)+", buy-out: "+i.format(e.buyout)+", net: "+i.format(e.delta)+", cum-sum: "+i.format(e.cumSum))})).on("mouseout",((t,e)=>{d3.select(t.currentTarget).transition().attr("r",s),I.style("background","#FFFFFF"),U.text(""),z.text("")})).on("click",((t,e)=>document.getElementById("game-"+e.id).scrollIntoView()));const q=d3.zoom().scaleExtent(c?[.7,v]:[.7,w]).on("zoom",(({transform:t})=>{k=t.rescaleX($),e.scale(k),u.call(e),g.selectAll("circle").attr("cx",(t=>k(d(t)))),g.selectAll("path").attr("d",(t=>M(t.data)))}));S.call(q).on("wheel",(t=>t.preventDefault())).on("dblclick.zoom",null).on("dblclick",(()=>{c=!c,k=(c?d3.scaleUtc:d3.scaleLinear)().domain(c?[y,x]:[.9,b]).range([0,h-l.left-l.right]),$=k.copy(),c?q.scaleExtent([.7,v]):q.scaleExtent([.7,w]),e.scale(k),u.transition().call(e),g.selectAll("circle").transition().attr("cx",(t=>k(d(t)))),g.selectAll("path").transition().attr("d",(t=>M(t.data))).on("end",(()=>S.call(q.transform,d3.zoomIdentity)))}));for(const t of p){const e=document.getElementById("player-card-"+t.name);e.addEventListener("mouseover",(e=>{d3.selectAll(".line").style("opacity",.15),d3.selectAll(".circle").style("opacity",.6),P.selectAll("path").filter((e=>e.name===t.name)).style("opacity",.85).style("stroke-width",n),D.style("background","rgb("+t.colourRgb+")"),E.style("background","rgb("+t.colourRgb.map((t=>t+.4*(255-t)))+")"),B.attr("src",t.avatar),F.text(t.name),L.text(i.format(t.cumSum))})),e.addEventListener("mouseout",(e=>{d3.selectAll(".line").style("opacity",.6),d3.selectAll(".circle").style("opacity",o),P.selectAll("path").filter((e=>e.name===t.name)).style("stroke-width",r).style("cursor","none")}))}};return M(),()=>{h=Math.min(a,document.getElementById(e).clientWidth),f=.5*h,k.range([0,h-l.left-l.right]),A.range([f-l.top-l.bottom,0]),S.selectAll("*").remove(),M()}},drawPiePlot=(t,e,a,l)=>{const r=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}),n=d3.select("#"+e).append("svg"),o=d3.pie().value((t=>Math.abs(t.cumSum)))(t),s=t.reduce(((t,e)=>t+e.cumSum),0),c=d3.select("#"+e).append("div").style("opacity",0).style("position","absolute").attr("class","tooltip"),d=(t,e)=>c.style("left",t.pageX+30+"px").style("top",t.pageY-20+"px"),i=(t,e)=>c.style("opacity",0),m=(t,e)=>c.style("opacity",.8).html(`cumulative sum: ${r.format(e.data.cumSum)}<br>percent total ${e.data.cumSum>0?"winnings":"losses"}: ${Math.round(e.data.cumSum/s*100*10)/10}%`),p=()=>{const t=Math.min(a,document.getElementById(e).clientWidth),r=t,s=Math.min(t-l.left-l.right,r-l.top-l.bottom)/2,c=n.attr("viewBox","0 0 "+(t+l.left+l.right)+" "+(r+l.top+l.bottom)).append("g").attr("transform","translate("+(t+l.left+l.right)/2+","+(r+l.top+l.bottom)/2+")"),p=d3.arc().innerRadius(.5*s).outerRadius(.8*s),u=d3.arc().innerRadius(.9*s).outerRadius(.9*s),g=c.selectAll("g.slice").data(o).enter().append("g");g.append("path").attr("d",p).attr("fill",(t=>t.data.colourHex)).attr("stroke","white").style("stroke-width","2px").style("opacity",.7).on("mouseover",m).on("mousemove",d).on("mouseout",i);const y=t=>t.startAngle+(t.endAngle-t.startAngle)/2;g.append("polyline").attr("stroke","black").style("fill","none").attr("stroke-width",1).attr("points",(function(t){const e=p.centroid(t),a=u.centroid(t);let l=u.centroid(t);return l[0]=.95*s*(y(t)<Math.PI?1:-1),[e,a,l]})).on("mouseover",m).on("mousemove",d).on("mouseout",i),g.append("text").attr("transform",(t=>{const e=u.centroid(t);return e[0]=.99*s*(y(t)<Math.PI?1:-1),"translate("+e+")"})).style("text-anchor",(t=>y(t)<Math.PI?"start":"end")).text((t=>t.data.name)).on("mouseover",m).on("mousemove",d).on("mouseout",i)};return p(),()=>{n.selectAll("*").remove(),p()}};fetch("https://mwiens91.github.io/poker-plots/data/data.min.json").then((t=>t.json())).then((t=>{const e={top:20,bottom:20,left:30,right:30},a={top:0,bottom:0,left:27,right:27},l=950,r=drawLinePlot(t,"line-plot-parent",l,e),n=drawBoxPlot(t,"box-plot-parent",l,e),o=drawPiePlot(t.players.filter((t=>t.cumSum>0)),"winner-pie-chart-parent",l,a),s=drawPiePlot(t.players.filter((t=>t.cumSum<0)),"loser-pie-chart-parent",l,a);drawCalendar(t,"calendar-parent",{top:0,bottom:0,left:0,right:0}),window.addEventListener("resize",r),window.addEventListener("resize",n),window.addEventListener("resize",o),window.addEventListener("resize",s)})),window.addEventListener("resize",(()=>{document.documentElement.clientWidth<950?document.getElementById("calendar").style.display="none":document.getElementById("calendar").style.display="block"}));
