const drawBoxPlot=(t,e,a,n)=>{const o=20,l=t=>Math.max(Math.min(100*Math.floor(document.documentElement.clientHeight/100)-200,.65*t),.45*t),r=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}),s=t.players.filter((t=>t.data.length>=5)).map((t=>{const e=t.data.map((t=>t.cumSum)),a=d3.quantile(e,.25),n=d3.quantile(e,.5),o=d3.quantile(e,.75),l=o-a,r=d3.max([d3.min(e),a-1.5*l]),s=d3.min([d3.max(e),o+1.5*l]);return{...t,quartiles:[a,n,o],range:[r,s],outliers:e.filter((t=>t<r||t>s)).map((e=>({value:e,name:t.name})))}}));let i=Math.min(a,document.getElementById(e).clientWidth),d=l(i);const m=d3.scaleBand().domain(s.map((t=>t.name))).paddingInner(1).paddingOuter(.5).range([0,i-n.left-n.right]),c=d3.scaleLinear().domain(d3.extent(s.map((t=>[...t.outliers.map((t=>t.value)),...t.range])).flat()).map((t=>1.05*t))).range([d-n.top-n.bottom,0]),p=d3.select("#"+e).append("svg"),u=d3.select("#"+e).append("div").style("opacity",0).style("position","absolute").attr("class","tooltip"),g=t=>u.style("left",t.pageX+30+"px").style("top",t.pageY-20+"px"),y=()=>u.style("opacity",0),h=(t,e)=>u.style("opacity",.8).html(`<b>${e.name}</b><br>max: ${r.format(e.range[1])}<br>75% quantile: ${r.format(e.quartiles[2])}<br>50% quantile: ${r.format(e.quartiles[1])}<br>25% quantile: ${r.format(e.quartiles[0])}<br>min: ${r.format(e.range[0])}`),f=(t,e)=>u.style("opacity",.8).html(`<b>${e.name}</b><br>outlier: ${r.format(e.value)}`),x=()=>{const t=p.attr("viewBox","0 0 "+(i+n.left+n.right)+" "+(d+n.top+n.bottom)).append("g").attr("transform",`translate(${n.left+n.right}, ${n.top+n.bottom})`),e=d3.axisBottom(m),a=d3.axisLeft(c).tickFormat((t=>r.format(t))).ticks(10),l=d3.axisLeft(c).tickSize(n.left+n.right-i).tickFormat("").ticks(10).tickSizeOuter(0);t.append("g").attr("class","y axis-grid").call(l),t.append("g").attr("class","x axis").attr("transform",`translate(0, ${d-n.top-n.bottom})`).call(e),t.append("g").attr("class","y axis").call(a).append("text").attr("y",15).attr("transform","rotate(-90)").attr("fill","#000").text("cumulative sum (CAD)"),t.selectAll("vertlines").data(s).enter().append("path").attr("d",(t=>`\n      M${m(t.name)}, ${c(t.range[1])}\n      V${c(t.quartiles[2])}\n      `)).attr("stroke","black").on("mouseover",h).on("mousemove",g).on("mouseout",y),t.selectAll("vertlines").data(s).enter().append("path").attr("d",(t=>`\n      M${m(t.name)}, ${c(t.quartiles[0])}\n      V${c(t.range[0])}\n      `)).attr("stroke","black").on("mouseover",h).on("mousemove",g).on("mouseout",y),t.selectAll("boxes").data(s).enter().append("path").attr("fill",(t=>t.colourHex)).attr("d",(t=>`\n        M${m(t.name)+o}, ${c(t.quartiles[2])}\n        H${m(t.name)-o}\n        V${c(t.quartiles[0])}\n        H${m(t.name)+o}\n        Z\n      `)).style("opacity",.8).on("mouseover",h).on("mousemove",g).on("mouseout",y),t.selectAll("horizlines").data(s).enter().append("path").attr("stroke","black").attr("d",(t=>`\n        M${m(t.name)+o},${c(t.quartiles[1])}\n        H${m(t.name)-o}\n      `)).on("mouseover",h).on("mousemove",g).on("mouseout",y),t.selectAll("horizlines").data(s).enter().append("path").attr("stroke","black").attr("d",(t=>`\n        M${m(t.name)+o/3},${c(t.range[1])}\n        H${m(t.name)-o/3}\n      `)).on("mouseover",h).on("mousemove",g).on("mouseout",y),t.selectAll("horizlines").data(s).enter().append("path").attr("stroke","black").attr("d",(t=>`\n        M${m(t.name)+o/3},${c(t.range[0])}\n        H${m(t.name)-o/3}\n      `)).on("mouseover",h).on("mousemove",g).on("mouseout",y),t.selectAll("circle-group").data(s).enter().append("g").attr("fill",(t=>t.colourHex)).attr("fill-opacity",.5).attr("stroke","none").attr("transform",(t=>`translate(${m(t.name)}, 0)`)).selectAll("circle").data((t=>t.outliers)).enter().append("g").attr("class","circle").append("circle").attr("r",3).attr("cx",(()=>0*(Math.random()-.5))).attr("cy",(t=>c(t.value))).on("mouseover",f).on("mousemove",g).on("mouseout",y)};return x(),()=>{i=Math.min(a,document.getElementById(e).clientWidth),d=l(i),m.range([0,i-n.left-n.right]),c.range([d-n.top-n.bottom,0]),p.selectAll("*").remove(),x()}},drawCalendar=(t,e,a)=>{const n=17,o=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}),l=d3.utcParse("%Y-%m-%d"),r=t.games.map((t=>({date:l(t.date),val:t.data.reduce(((t,e)=>t+e.buyin),0),id:t.id}))),s=new Set,i=[];for(let t=0;t<r.length-1;t++){if(s.has(t))continue;const e=r[t].date,a=r.map(((t,a)=>t.date.getTime()===e.getTime()?a:"")).filter(String);if(1!==a.length){for(let e=1;e<a.length;e++)r[t].val+=r[e].val,i.push(e),s.add(e);for(const t of i.reverse())r.splice(t,1)}}const d=d3.utcDays(new Date(Date.UTC(r[r.length-1].date.getFullYear(),0,1)),r[r.length-1].date),m=d3.utcDays(r[0].date,new Date(Date.UTC(r[0].date.getFullYear()+1,0,1)));m.shift();const c=[...d,...m];r.reduce(((t,e)=>{const a=d3.utcDays(e.date,t.date);return a.shift(),c.push(...a),e}));for(const t of c)r.push({date:t,val:0,id:null});r.sort(((t,e)=>e.date-t.date));const p=d3.map(r,(t=>t.date)),u=d3.map(r,(t=>t.val)),g=d3.range(p.length),y=d3.groups(g,(t=>p[t].getUTCFullYear())),h=d3.utcFormat("%b"),f=d3.scaleSqrt().domain([0,d3.max(r.map((t=>t.val)))]).range(["#ebedf0","teal"]),x=d3.select("#"+e).append("svg").attr("id","calendar-svg"),b=d3.select("#"+e).append("div").style("opacity",0).style("position","absolute").attr("class","tooltip");x.attr("width",950+a.left+a.right).attr("height",153*y.length+a.top+a.bottom).attr("viewBox","0 0 "+(950+a.left+a.right)+" "+(153*y.length+a.top+a.bottom)).attr("font-family","sans-serif").attr("font-size",10);const v=x.selectAll("g").data(y).join("g").attr("transform",((t,e)=>`translate(40.5,${153*e+25.5})`));v.append("text").attr("x",-5).attr("y",-5).attr("font-weight","bold").attr("text-anchor","end").text((([t])=>t)),v.append("g").attr("text-anchor","end").selectAll("text").data(d3.range(7)).join("text").attr("x",-5).attr("y",(t=>(t+.5)*n)).attr("dy","0.31em").text((t=>"SMTWRFS"[t])),v.append("g").selectAll("rect").data((([,t])=>t)).join("rect").attr("width",16).attr("height",16).attr("x",(t=>d3.utcSunday.count(d3.utcYear(p[t]),p[t])*n+.5)).attr("y",(t=>p[t].getUTCDay()*n+.5)).attr("fill",(t=>f(u[t]))).on("mouseover",((t,e)=>b.style("opacity",.8).html(`<b>${p[e].toLocaleDateString("en-US",{timeZone:"UTC",weekday:"long",year:"numeric",month:"long",day:"numeric"})}</b><br>`+(null===r[e].id?"no game":`total buy-ins: ${o.format(r[e].val)}`)))).on("mousemove",(t=>b.style("left",t.pageX+30+"px").style("top",t.pageY-20+"px"))).on("mouseout",(()=>b.style("opacity",0))).on("click",((t,e)=>null===r[e].id?null:document.getElementById("game-"+r[e].id).scrollIntoView()));const w=v.append("g").selectAll("g").data((([,t])=>d3.utcMonths(p[t[t.length-1]],p[t[0]]))).join("g");w.filter(((t,e)=>e)).append("path").attr("fill","none").attr("stroke","#fff").attr("stroke-width",3).attr("d",(t=>{const e=Math.min(7,t.getUTCDay()),a=d3.utcSunday.count(d3.utcYear(t),t);return(7===e?`M${(a+1)*n},0`:`M${(a+1)*n},0V${e*n}H${a*n}`)+"V119"})),w.append("text").attr("x",(t=>d3.utcSunday.count(d3.utcYear(t),d3.utcSunday.ceil(t))*n+2)).attr("y",-5).text(h)},drawLinePlot=(t,e,a,n)=>{const o="0.1rem",l="0.2em",r=t=>Math.max(Math.min(100*Math.floor(document.documentElement.clientHeight/100)-420,.65*t),.45*t);let s=!0;const i=t=>s?t.date:t.id,d=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}),m=d3.utcParse("%Y-%m-%d"),c=t.players.map((t=>({...t,data:t.data.map((t=>({...t,date:m(t.date)})))})));for(const t of c){const e=t.data.length,a=new Set;for(let n=0;n<e-1;n++){if(a.has(t.data[n].id))continue;const e=t.data[n].date,o=t.data.filter((t=>t.date.getTime()===e.getTime())),l=o.length;if(1===l)continue;const r=o.map((t=>t.id));for(let e=1;e<l;e++){const a=24*e/(l+1);t.data.find((t=>t.id===r[e])).date.setHours(t.data[e].date.getHours()+a)}r.forEach((t=>a.add(t)))}}const p=c.map((t=>t.data.map((t=>t.date)))).flat(),u=d3.min(p),g=new Date(Number(u));g.setDate(u.getDate()-1);let y=Math.min(a,document.getElementById(e).clientWidth),h=r(y);const f=d3.max(p),x=d3.max(t.games.map((t=>t.id))),b=Math.max(1,(f.getTime()-u.getTime())/12096e5),v=Math.max(1,(x-1)/10);let w=(s?d3.scaleUtc:d3.scaleLinear)().domain(s?[g,f]:[.9,x]).range([0,y-n.left-n.right]),k=w.copy();const E=new Proxy(new URLSearchParams(window.location.search),{get:(t,e)=>t.get(e)}).lineYScaleExponent,S=d3.scalePow().exponent(null===E?1:parseFloat(E)).domain(d3.extent(c.map((t=>t.data.map((t=>t.cumSum)))).flat()).map((t=>1.05*t))).range([h-n.top-n.bottom,0]),I=d3.select("#"+e).append("svg"),$=d3.select("#line-plot-avatar-div"),B=d3.select("#line-plot-player-div"),C=d3.select("#line-plot-game-div"),A=d3.select("#line-plot-avatar"),M=d3.select("#line-plot-player"),D=d3.select("#line-plot-amount"),U=d3.select("#line-plot-game-title"),F=d3.select("#line-plot-game-info"),P=(t,e)=>{I.selectAll(".line").style("opacity",.15),I.selectAll(".circle").style("opacity",.15),I.selectAll(".line").filter((e=>e.name===t)).style("opacity",.7).style("stroke-width","0.15rem").style("cursor",(()=>e?"pointer":"none")),I.selectAll(".circle").filter((e=>e.player===t)).style("opacity",.85)},z=()=>{I.selectAll(".line").style("opacity",.6).style("stroke-width",o).style("cursor","none"),I.selectAll(".circle").style("opacity",.85)},H=t=>{$.style("background","rgb("+t.colourRgb+")"),B.style("background","rgb("+t.colourRgb.map((t=>t+.4*(255-t)))+")"),A.attr("src",t.avatar),M.text(t.name),D.text(d.format(t.cumSum))};for(const t of c){const e=document.getElementById("legend-icon-div-"+t.name);e.addEventListener("mouseover",(()=>{P(t.name,!1),H(t)})),e.addEventListener("mouseout",z)}const q=()=>{const t=I.attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+(y+n.left+n.right)+" "+(h+n.top+n.bottom)).append("g").attr("transform",`translate(${n.left+n.right}, ${n.top+n.bottom})`),e=d3.axisBottom(w),a=d3.axisLeft(S).tickFormat((t=>d.format(t))).ticks(10),r=d3.axisLeft(S).tickSize(n.left+n.right-y).tickFormat("").ticks(10).tickSizeOuter(0);t.append("g").attr("class","y axis-grid").call(r);const m=t.append("g").attr("class","x axis").attr("transform",`translate(0, ${h-n.top-n.bottom})`).call(e);t.append("g").attr("class","y axis").call(a).append("text").attr("y",15).attr("transform","rotate(-90)").attr("fill","#000").text("cumulative sum (CAD)"),t.append("defs").append("svg:clipPath").attr("id","clip").append("svg:rect").attr("width",y).attr("height",h).attr("x",0).attr("y",0);const p=t.append("g").attr("clip-path","url(#clip)"),u=d3.line().x((t=>w(i(t)))).y((t=>S(t.cumSum))),E=p.append("g").attr("class","lines");E.selectAll(".line-group").data(c).enter().append("g").attr("class","line-group").append("path").attr("class","line").attr("d",(t=>u(t.data))).style("stroke",(t=>t.colourHex)).style("stroke-width",o).style("opacity",.6).on("mouseover",((t,e)=>{P(e.name,!0),H(e)})).on("mouseout",z),E.selectAll("circle-group").data(c).enter().append("g").style("fill",(t=>t.colourHex)).selectAll("circle").data((t=>t.data)).enter().append("g").attr("class","circle").append("circle").attr("cx",(t=>w(i(t)))).attr("cy",(t=>S(t.cumSum))).attr("r",l).style("opacity",.85).on("mouseover",((t,e)=>{d3.select(t.currentTarget).transition().attr("r","0.4em").style("cursor","pointer");const a=c.find((t=>t.name===e.player));H(a),C.style("background","rgb("+a.colourRgb.map((t=>t+.8*(255-t)))+")"),U.text(e.date.toLocaleDateString("en-US",{timeZone:"UTC",weekday:"long",year:"numeric",month:"long",day:"numeric"})),F.text("net: "+d.format(e.delta)+", cum-sum: "+d.format(e.cumSum)+", buy-in: "+d.format(e.buyin)+", buy-out: "+d.format(e.buyout))})).on("mouseout",(t=>{d3.select(t.currentTarget).transition().attr("r",l).style("cursor","none"),C.style("background","#FFFFFF"),U.text(""),F.text("")})).on("click",((t,e)=>document.getElementById("game-"+e.id).scrollIntoView()));const $=d3.zoom().scaleExtent(s?[.7,b]:[.7,v]).on("zoom",(({transform:t})=>{w=t.rescaleX(k),e.scale(w),m.call(e),p.selectAll("circle").attr("cx",(t=>w(i(t)))),p.selectAll("path").attr("d",(t=>u(t.data)))}));I.call($).on("wheel",(t=>t.preventDefault())).on("dblclick.zoom",null).on("dblclick",(()=>{s=!s,w=(s?d3.scaleUtc:d3.scaleLinear)().domain(s?[g,f]:[.9,x]).range([0,y-n.left-n.right]),k=w.copy(),s?$.scaleExtent([.7,b]):$.scaleExtent([.7,v]),e.scale(w),m.transition().call(e),p.selectAll("circle").transition().attr("cx",(t=>w(i(t)))),p.selectAll("path").transition().attr("d",(t=>u(t.data))).on("end",(()=>I.call($.transform,d3.zoomIdentity)))}))};return q(),()=>{y=Math.min(a,document.getElementById(e).clientWidth),h=r(y),w.range([0,y-n.left-n.right]),S.range([h-n.top-n.bottom,0]),I.selectAll("*").remove(),q()}},initializePeopleSection=t=>{const e=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}),a=document.getElementById("people-body-avatar"),n=document.getElementById("people-body-player-title-name"),o=document.getElementById("people-body-player-title-divider"),l=document.getElementById("people-body-player-title-cumsum"),r=document.getElementById("people-body-hr"),s=document.getElementById("people-body-games-played"),i=document.getElementById("people-body-total-money-won"),d=document.getElementById("people-body-total-money-lost"),m=document.getElementById("people-body-most-money-won-consecutive-main"),c=document.getElementById("people-body-most-money-won-consecutive-sub"),p=document.getElementById("people-body-most-money-lost-consecutive-main"),u=document.getElementById("people-body-most-money-lost-consecutive-sub"),g=document.getElementById("people-body-most-money-won-single-main"),y=document.getElementById("people-body-most-money-won-single-sub"),h=document.getElementById("people-body-most-money-lost-single-main"),f=document.getElementById("people-body-most-money-lost-single-sub"),x=x=>{a.setAttribute("src",x.avatar),n.textContent=x.name,o.style.color=x.colourHex,l.textContent=e.format(x.cumSum),r.style.backgroundColor=x.colourHex,s.textContent=x.gameCount,i.textContent=e.format(x.stats["total-money-won"]),d.textContent=e.format(x.stats["total-money-lost"]),null===x.stats["largest-winning-streak"]?(m.textContent="?",c.textContent=x.name+" has never won a game"):1===x.stats["largest-winning-streak"]["num-games"]?(m.textContent="?",c.textContent=x.name+" has never won consecutive games"):(m.textContent=e.format(x.stats["largest-winning-streak"].total),c.textContent="on "+t.games.find((t=>t.id===x.stats["largest-winning-streak"]["start-game-id"])).date+" through "+t.games.find((t=>t.id===x.stats["largest-winning-streak"]["end-game-id"])).date+" ("+x.stats["largest-winning-streak"]["num-games"]+" games)"),null===x.stats["largest-losing-streak"]?(p.textContent="?",u.textContent=x.name+" has never lost a game"):1===x.stats["largest-losing-streak"]["num-games"]?(p.textContent="?",u.textContent=x.name+" has never lost consecutive games"):(p.textContent=e.format(-x.stats["largest-losing-streak"].total),u.textContent="on "+t.games.find((t=>t.id===x.stats["largest-losing-streak"]["start-game-id"])).date+" through "+t.games.find((t=>t.id===x.stats["largest-losing-streak"]["end-game-id"])).date+" ("+x.stats["largest-losing-streak"]["num-games"]+" games)"),null===x.stats["most-won-in-single-game"]?(g.textContent="?",y.textContent=x.name+" has never won a game"):(g.textContent=e.format(x.stats["most-won-in-single-game"].total),y.textContent="on "+t.games.find((t=>t.id===x.stats["most-won-in-single-game"]["game-id"])).date),null===x.stats["most-lost-in-single-game"]?(h.textContent="?",f.textContent=x.name+" has never lost a game"):(h.textContent=e.format(-x.stats["most-lost-in-single-game"].total),f.textContent="on "+t.games.find((t=>t.id===x.stats["most-lost-in-single-game"]["game-id"])).date)};for(const e of t.players){document.getElementById("people-icon-div-"+e.name).addEventListener("mouseover",(()=>x(e)))}const b=t.players[Math.floor(Math.random()*t.players.length)];x(b)},drawPiePlot=(t,e,a,n)=>{const o=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}),l=d3.select("#"+e).append("svg"),r=d3.pie().value((t=>Math.abs(t.cumSum)))(t),s=t.reduce(((t,e)=>t+e.cumSum),0),i=d3.select("#"+e).append("div").style("opacity",0).style("position","absolute").attr("class","tooltip"),d=t=>i.style("left",t.pageX+30+"px").style("top",t.pageY-20+"px"),m=()=>i.style("opacity",0),c=(t,e)=>i.style("opacity",.8).html(`<b>${e.data.name}</b><br>cumulative sum: ${o.format(e.data.cumSum)}<br>percent total ${e.data.cumSum>0?"winnings":"losses"}: ${Math.round(e.data.cumSum/s*100*10)/10}%`),p=()=>{const t=Math.min(a,document.getElementById(e).clientWidth),o=t,s=Math.min(t-n.left-n.right,o-n.top-n.bottom)/2,i=l.attr("viewBox","0 0 "+(t+n.left+n.right)+" "+(o+n.top+n.bottom)).append("g").attr("transform","translate("+(t+n.left+n.right)/2+","+(o+n.top+n.bottom)/2+")"),p=d3.arc().innerRadius(.5*s).outerRadius(.8*s),u=d3.arc().innerRadius(.9*s).outerRadius(.9*s);i.selectAll("g.slice").data(r).enter().append("g").append("path").attr("d",p).attr("fill",(t=>t.data.colourHex)).attr("stroke","white").style("stroke-width","2px").style("opacity",.7).on("mouseover",c).on("mousemove",d).on("mouseout",m);const g=t=>t.startAngle+(t.endAngle-t.startAngle)/2,y=i.selectAll("g.slice").data(r.filter((t=>t.endAngle-t.startAngle>.1))).enter().append("g");y.append("polyline").attr("stroke","black").style("fill","none").attr("stroke-width",1).attr("points",(function(t){const e=p.centroid(t),a=u.centroid(t),n=u.centroid(t);return n[0]=.95*s*(g(t)<Math.PI?1:-1),[e,a,n]})).on("mouseover",c).on("mousemove",d).on("mouseout",m),y.append("text").attr("transform",(t=>{const e=u.centroid(t);return e[0]=.99*s*(g(t)<Math.PI?1:-1),"translate("+e+")"})).style("text-anchor",(t=>g(t)<Math.PI?"start":"end")).text((t=>t.data.name)).on("mouseover",c).on("mousemove",d).on("mouseout",m)};return p(),()=>{l.selectAll("*").remove(),p()}};fetch("https://mwiens91.github.io/poker-plots/data/data.min.json").then((t=>t.json())).then((t=>{initializePeopleSection(t);const e={top:0,bottom:0,left:27,right:27},a=950,n=drawLinePlot(t,"line-plot-parent",a,{top:10,bottom:20,left:30,right:30}),o=drawBoxPlot(t,"box-plot-parent",a,{top:20,bottom:20,left:30,right:30}),l=drawPiePlot(t.players.filter((t=>t.cumSum>0)),"winner-pie-chart-parent",a,e),r=drawPiePlot(t.players.filter((t=>t.cumSum<0)),"loser-pie-chart-parent",a,e);drawCalendar(t,"calendar-parent",{top:0,bottom:0,left:0,right:0});const s=document.getElementById("main-container");let i=null;new ResizeObserver((t=>{for(const e of t){const t=e.borderBoxSize[0].inlineSize;null===i?i=t:t!==i&&(i=t,n(),o(),l(),r())}})).observe(s);let d=100*Math.floor(document.documentElement.clientHeight/100);window.addEventListener("resize",(()=>{const t=100*Math.floor(document.documentElement.clientHeight/100);t!==d&&(d=t,n(),o())}))}));const calendarElement=document.getElementById("calendar"),alertBoxElement=document.getElementById("alert-box"),hideCalendarIfViewportNarrow=()=>{document.documentElement.clientWidth<992?(calendarElement.style.display="none",alertBoxElement.style.display="block"):(calendarElement.style.display="block",alertBoxElement.style.display="none")};hideCalendarIfViewportNarrow(),window.addEventListener("resize",hideCalendarIfViewportNarrow);const circleElem=document.getElementById("page-up-circle"),observer=new IntersectionObserver((t=>{t[0].isIntersecting?circleElem.style.display="block":circleElem.style.display="none"}),{rootMargin:"0px 0px -80% 0px",threshold:[0]});observer.observe(document.querySelector("#scroll-up-visible"));
